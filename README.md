# API-PVZ: Сервис управления пунктами выдачи заказов

API-PVZ - это сервис для управления пунктами выдачи заказов (ПВЗ), который позволяет создавать ПВЗ, управлять приёмками заказов и товарами.

## Функциональность
- Создание и управление пунктами выдачи заказов
- Открытие и закрытие приёмок заказов
- Добавление товаров различных типов (электроника, одежда, обувь)
- Аутентификация пользователей с разными ролями (клиент, модератор)
- Метрики для мониторинга работы сервиса

## Технологии
- Golang
- PostgreSQL
- Docker & Docker Compose
- Prometheus (для метрик)
- JWT для аутентификации

## Требования
- Go 1.20+
- Docker и Docker Compose
- PostgreSQL
- golang-migrate (инструмент для миграций)

## Установка и запуск

### Клонирование репозитория
```bash
git clone https://github.com/Egorpalan/api-pvz.git
cd api-pvz
```

### Запуск с помощью Docker-compose
Убедитесь что в `.env` и `docker-compose` выставлены нужные вам порты

Пример настройки в `.env.example`
```bash
make compose-up
```
Это запустит:
* PostgreSQL базу данных на порту 5436 локально и 5432 в контейнере
* REST сервис на порту 8080
* GRPC сервис на порту 3000
* Prometheus для сбора метрик

По адресу http://localhost:9000/metrics будут доступны метрики сервиса

### Применение sql-миграций
Для создания таблиц
```bash
make migrate-up
```

Для удаления таблиц
```bash
make migrate-down
```


### Запуск unit-тестов
```bash
make test 
```

### Запуск интеграционного теста
```bash
make test-integration
```


## Метрики
Метрики доступны по адресу http://localhost:9000/metrics и включают:
* Количество созданных ПВЗ
* Количество открытых/закрытых приёмок
* Количество добавленных товаров
* Метрики HTTP запросов (время ответа, количество запросов)


Вот файл в формате .md, содержащий описание всех endpoint-ов вашего API. Сохрани его как, например, api_endpoints.md в корне проекта:

## API Endpoints

> Все защищённые ручки требуют передачи JWT токена в заголовке:

Authorization: Bearer <your_token>

---

### Авторизация и регистрация

#### POST /dummyLogin

Получение токена


#### POST /register

Регистрация нового пользователя.

#### POST /login

Авторизация по email и паролю.


### Работа с ПВЗ

#### POST /pvz

Создание нового ПВЗ (только для moderator).

#### GET /pvz

Получение списка ПВЗ с приёмками и товарами.



### Работа с приёмками

#### POST /reception

Создание новой приёмки (только для client).

#### PUT /reception

Закрытие последней приёмки (только для client).


### Работа с товарами

#### POST /products

Добавление товара в активную приёмку.


#### DELETE /products

Удаление последнего добавленного товара (по LIFO). Только в незакрытой приёмке.


## grpc

Для выполнения grpc-запроса введите в терминале
```bash
grpcurl -plaintext -proto internal/grpc/pvz_v1/pvz.proto localhost:3000 pvz.v1.PVZService/GetPVZList
```


## Кодогенерация

Для кодогенерации использовался пакет [oapi-codegen](https://github.com/oapi-codegen/oapi-codegen)